syntax = "proto3";

package replication;

service Replication {
  rpc StreamWalV2(StreamWalV2Request) returns (stream StreamWalV2Response);
  rpc StreamSnapshotV2(StreamSnapshotV2Request) returns (stream StreamSnapshotV2Response);
  rpc AckLsnV2(AckLsnV2Request) returns (AckLsnV2Response);
}

message LsnToken {
  string generation = 1;
  uint64 index = 2;
  uint64 offset = 3;
}

message StreamWalV2Request {
  string db_identity = 1;
  string replica_id = 2;
  string session_id = 3;
  LsnToken start_lsn = 4;
}

message WalChunkV2 {
  LsnToken start_lsn = 1;
  LsnToken next_lsn = 2;
  bytes wal_bytes = 3;
}

message StreamWalV2Response {
  oneof payload {
    WalChunkV2 chunk = 1;
    StreamError error = 2;
  }
}

message StreamSnapshotV2Request {
  string db_identity = 1;
  string replica_id = 2;
  string session_id = 3;
  LsnToken start_lsn = 4;
}

message SnapshotMeta {
  string db_identity = 1;
  string generation = 2;
  LsnToken boundary_lsn = 3;
  uint32 page_size = 4;
  uint64 snapshot_size_bytes = 5;
  bytes snapshot_sha256 = 6;
}

message StreamSnapshotV2Response {
  oneof payload {
    SnapshotMeta meta = 1;
    bytes chunk = 2;
    StreamError error = 3;
  }
}

message AckLsnV2Request {
  string db_identity = 1;
  string replica_id = 2;
  string session_id = 3;
  LsnToken last_applied_lsn = 4;
}

message AckLsnV2Response {
  bool accepted = 1;
  StreamError error = 2;
}

message StreamError {
  enum Code {
    UNKNOWN = 0;
    LINEAGE_MISMATCH = 1;
    WAL_NOT_RETAINED = 2;
    SNAPSHOT_BOUNDARY_MISMATCH = 3;
    INVALID_LSN = 4;
  }
  Code code = 1;
  string message = 2;
  uint32 retry_after_ms = 3;
}
